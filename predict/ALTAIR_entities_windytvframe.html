<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/leaflet@0.7.7/dist/leaflet.js"></script>
    <script src="https://cdn.rawgit.com/Leaflet/Leaflet.label/0.8/dist/leaflet.label.js"></script>
    <script src="https://api4.windy.com/assets/libBoot.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <style type="text/css">
      #windy {
                 width: 100%;
                 height: 308px;
               }
      .labeltext { width: 400px; }
	  
	  .height-control, .time-slider {
			width: 200px;
	  }
	  
	  .height-control .ui-slider-handle {
			font-size: 12px;
			width: 50px;
		}
		
	  .location_marker {
			width: 300px
	  }
    </style>
  </head>
  <body>
    <div id="windy"></div>

    <script type="text/javascript">

    var lastMarker = 0;
    var lastPolyline = 0;
    var lastPredline = 0;
    var latLonsALTAIRPath = [];
    var latLonsALTAIRPred = [];

    const options = {

                // Required: API key
                key: 'OznecmCq1hd17S4F3e5rtotajmkUBw2D',

                // Put additional console output
                verbose: true,

                // Optional: Initial state of the map
          lat:   48.46,
          lon: -123.31,
          zoom: 14,
          layers: [
            L.tileLayer('http://b.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              minZoom: 12,
              maxZoom: 17,
              attribution: 'Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, '
            })
          ],
          minZoom: 4,
          maxZoom: 17
    }

    // Initialize Windy API
    windyInit( options, windyAPI => {
        // windyAPI is ready, and contains 'map', 'store',
        // 'picker' and other useful stuff

      var aLTAIRLatInput = window.parent.p5frame.document.getElementById('gLTAIRLat');
      var aLTAIRLonInput = window.parent.p5frame.document.getElementById('gLTAIRLon');
      var ALTAIRLat      = parseFloat(aLTAIRLatInput.value);
      var ALTAIRLon      = parseFloat(aLTAIRLonInput.value);

        const { map, picker, utils, overlays, broadcast } = windyAPI;
//        var { map } = windyAPI
        // .map is instance of Leaflet map

        overlays.wind.setMetric('m/s');

        picker.on('pickerOpened', latLon => {
            // picker has been opened at latLon coords

            let { lat, lon, values, overlay } = picker.getParams();

            let windObject = utils.wind2obj( values );

            console.log( windObject );

        });

        picker.on('pickerMoved', latLon => {
            // picker was dragged by user to latLon coords
        });

        picker.on('pickerClosed', () => {
            // picker was closed
        });

        broadcast.once('redrawFinished', () => {
             picker.open({ lat: ALTAIRLat, lon: ALTAIRLon });
             // Opening of a picker (async)
        });

        map.options.minZoom = 4;
        map.options.maxZoom = 17;

        var topLayer = L.tileLayer('http://b.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, ',
            minZoom: 12,
            maxZoom: 17
        }).addTo(map);
        topLayer.setOpacity('0');

        map.on('zoomend', function() { 
            if (map.getZoom() >= 12) {
                topLayer.setOpacity('1');
            } else {
                topLayer.setOpacity('0');   
            }
        });
        map.setZoom(14);

        setInterval(function () {
                aLTAIRLatInput = window.parent.p5frame.document.getElementById('gLTAIRLat');
                aLTAIRLonInput = window.parent.p5frame.document.getElementById('gLTAIRLon');
                var aLTAIRAltInput = window.parent.p5frame.document.getElementById('gLTAIRAlt');
                var aLTAIRTerInput = window.parent.cesiumframe.document.getElementById('terrHeight');

        var ALTAIRTer      = parseFloat(aLTAIRTerInput.value);
        var ALTAIRAlt      = aLTAIRAltInput.value;

                var roundALTAIRAlt = Math.round(ALTAIRAlt);
                var roundALTAIRTer = Math.round(ALTAIRTer);

                var lat = parseFloat(aLTAIRLatInput.value);
                var lon = parseFloat(aLTAIRLonInput.value);
                makePred(map);
                latLonsALTAIRPath.push([lat,lon]);

//                broadcast.once('redrawFinished', () => {
                broadcast.on('redrawFinished', () => {
//                    picker.open({ lat: 48.49, lon: -123.312 });
                    picker.open({ lat: lat, lon: lon });
                    // Opening of a picker (async)
                });

// W and W.interpolation.interpolateValues are not available in Windy API v4.0 (or 3.0) -- only in v2.3
//                var values = W.interpolation.interpolateValues(lat, lon, roundALTAIRAlt);

                if (lastMarker != 0) {
//                      lastMarker.remove();
                        map.removeLayer(lastMarker);
                }
                if (lastPolyline != 0) {
//                      lastPolyline.remove();
                        map.removeLayer(lastPolyline);
                }
                if($(".location_marker").length) {
//                      $(".location_marker").remove();
                        map.removeLayer($(".location_marker"));
                }

                var ALTAIRAltText = '   ALTAIR = ' + roundALTAIRAlt + ' m ASL<br/>    Terrain&nbsp; =  &nbsp;  ' + roundALTAIRTer +'  m ASL<br/>';
// Need some other method for getting wind speed and angle at ALTAIR's location within Windy API v4.0
//                ALTAIRAltText += locationValue(values);

                var thePolyline = L.polyline(latLonsALTAIRPath, {color: 'red'}).addTo( map );
                lastPolyline = thePolyline;

                var marker = L.marker([lat, lon])
                    .bindLabel(ALTAIRAltText, { noHide: true, offset: [20,-40], className: "location_marker" })
                    .addTo( map );
                marker.setOpacity( 0.65 );
                lastMarker = marker;

               $(".location_marker").html(ALTAIRAltText);


        }, 10000);

      map.panTo([ALTAIRLat, ALTAIRLon]);

    })


        function makePred(map) {
                $.ajax({
                    url:      'flight_path.csv',
                    dataType: 'text',
                    success:  function(result) {
                         if (lastPredline != 0) {
//                            lastPredline.remove();
                              map.removeLayer(lastPredline);
                         }
                         var allRows = result.split(/\r?\n|\r/);
                         latLonsALTAIRPred = [];
                         for (var singleRow = 0; singleRow < allRows.length; singleRow++) {
                            var rowCells = allRows[singleRow].split(',');
                            var theLat = parseFloat(rowCells[1]);
                            var theLon = parseFloat(rowCells[2]);
                            if (theLat > -90. && theLat < 90. && theLon > -180. && theLon < 180.) {
                               latLonsALTAIRPred.push([theLat,theLon]);
                            }
                         }
                         var thePredline = L.polyline(latLonsALTAIRPred, {color: 'blue'}).addTo( map );
                         lastPredline = thePredline;
                    }
                });
        }

    </script>

  </body>
</html>
